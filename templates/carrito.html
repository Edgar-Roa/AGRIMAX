<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Carrito</title>
    <link rel="stylesheet" href="/static/css/boton_hamburguesaP.css">
    <link rel="stylesheet" href="/static/css/carrito.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link rel="stylesheet" href="/static/css/footer.css">
</head>
<body>

{% if not session.get('usuario_id') %}
<script>
    window.location.href = "{{ url_for('login') }}";
</script>
{% endif %}

<header class="header">
    <div class="logo" onclick="location.href='/menu_principal'">AGRIMAX</div>
    <button id="menuBtn" class="menu-btn">☰</button>
    <div class="header-right">
        <button class="cart-btn" onclick="location.href='{{ url_for('carrito.carrito') }}'">
            <i class="fas fa-shopping-cart"></i>
        </button>
    </div>
</header>

<div id="sidebar" class="sidebar">
    <ul class="sidebar-menu">

        <li><a href="{{ url_for('usuarios.perfil', usuario_id=session['usuario_id']) }}">PERFIL</a></li>
        <li><a href="{{ url_for('menu_clientes.menu_principal') }}">MENÚ PRINCIPAL</a></li>
        <li>
            <button class="dropdown-btn">CATEGORÍAS <i class="fas fa-caret-down"></i></button>
            <ul class="dropdown-container">
                <li><a href="{{ url_for('verduras.verduras') }}">Verduras</a></li>
                <li><a href="{{ url_for('frutas.frutas') }}">Frutas</a></li>
                <li><a href="{{ url_for('legumbres.legumbres') }}">Legumbres</a></li>
                <li><a href="{{ url_for('hortalizas.hortalizas') }}">Hortalizas</a></li>
            </ul>
        </li>
        <li><a href="{{ url_for('configuracion.configuracion') }}">CONFIGURACIÓN</a></li>
        <li><a href="{{ url_for('logout.logout') }}" class="logout-btn">CERRAR SESIÓN</a></li>
    </ul>
</div>

<div id="overlay" class="overlay"></div>

<main>
    <h1>Carrito de Compras</h1>

    <div class="cart-container">
    {% if productos %}
        {% for producto in productos %}
        <div class="cart-item">
            <img src="{{ url_for('static', filename=producto.imagen) if producto.imagen else url_for('static', filename='imagenes/default-product.jpg') }}" alt="{{ producto.nombre }}">
            <div class="item-info">
                <h3>{{ producto.nombre }}</h3>
                <p>{{ producto.descripcion }}</p>
                <p><strong>Categoría:</strong> {{ producto.categoria }}</p>
                <p><strong>Precio unitario:</strong> ${{ producto.precio }}</p>
            <input type="number"
                 name="cantidad"
                value="{{ producto.cantidad }}"
                min="0"
                class="cantidad-input"
                data-producto-id="{{ producto.id }}"
            >
                <p><strong>Subtotal:</strong> ${{ producto.subtotal }}</p>
            </div>
        </div>
        {% endfor %}
        <h2 class="total-price">Total: ${{ total }}</h2>
    {% else %}
        <p>Tu carrito está vacío.</p>
    {% endif %}
    {% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="flash {{ category }}">{{ message }}</div>
    {% endfor %}
  {% endif %}
{% endwith %}
</div>
    <div class="button-group">
        <form method="POST" action="{{ url_for('vaciar_carrito.vaciar_carrito') }}">
            <button type="submit" class="btn-cancelar">Vaciar Carrito</button>
        </form>
        <form method="POST" action="{{ url_for('confirmar_pedidos.confirmar_pedido') }}" onsubmit="sessionStorage.setItem('compraExitosa', true);">
            <button type="submit" class="btn-comprar">Comprar</button>
        </form>
    </div>
</main>

<script src="/static/js/carrito.js"></script>
<script src="/static/js/boton_hamburguesaP.js"></script>
<script>
document.querySelectorAll('.cantidad-input').forEach(input => {
    input.addEventListener('change', function () {
        const productoId = this.dataset.productoId;
        const nuevaCantidad = this.value;

        fetch('/actualizar_cantidad', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-Requested-With': 'XMLHttpRequest' // para distinguir AJAX
            },
            body: JSON.stringify({
                producto_id: productoId,
                nueva_cantidad: nuevaCantidad
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload(); // recarga para ver el nuevo subtotal y total
            } else {
                alert(data.message || "Error al actualizar cantidad.");
            }
        });
    });
});
</script>
<footer>
    <p>© 2025 AGRIMAX. TODOS LOS DERECHOS RESERVADOS.</p>

</footer>
</body>
</html>
